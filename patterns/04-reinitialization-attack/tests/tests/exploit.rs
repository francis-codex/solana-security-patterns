/// # Pattern 4: Re-initialization Attack — Mollusk Exploit Tests
///
/// Demonstrates how an attacker can re-initialize an already-configured account
/// to replace the authority and seize control.
///
/// - Test 1: EXPLOIT — re-init overwrites the authority with attacker's key.
/// - Test 2: SECURE — manual is_initialized guard blocks the re-init.
/// - Test 3: SANITY — first-time secure init succeeds.
use mollusk_svm::{result::Check, Mollusk};
use sha2::{Digest, Sha256};
use solana_sdk::{
    account::AccountSharedData,
    instruction::{AccountMeta, Instruction},
    program_error::ProgramError,
    pubkey::Pubkey,
};

const PROGRAM_ID: Pubkey = solana_sdk::pubkey!("2P1GgtagVaYR8B6FhrPHdP4Mmy3pUFAZtSyeWFK293vg");

// ---------------------------------------------------------------------------
// Helpers
// ---------------------------------------------------------------------------

fn ix_discriminator(name: &str) -> [u8; 8] {
    let mut hasher = Sha256::new();
    hasher.update(format!("global:{name}").as_bytes());
    let hash = hasher.finalize();
    let mut disc = [0u8; 8];
    disc.copy_from_slice(&hash[..8]);
    disc
}

fn account_discriminator(name: &str) -> [u8; 8] {
    let mut hasher = Sha256::new();
    hasher.update(format!("account:{name}").as_bytes());
    let hash = hasher.finalize();
    let mut disc = [0u8; 8];
    disc.copy_from_slice(&hash[..8]);
    disc
}

/// Serialize a Config account:
///   [8-byte discriminator][32-byte authority][1-byte is_initialized][8-byte vault_balance]
fn serialize_config(authority: &Pubkey, is_initialized: bool, vault_balance: u64) -> Vec<u8> {
    let disc = account_discriminator("Config");
    let mut data = Vec::with_capacity(49);
    data.extend_from_slice(&disc);
    data.extend_from_slice(authority.as_ref());
    data.push(if is_initialized { 1 } else { 0 });
    data.extend_from_slice(&vault_balance.to_le_bytes());
    data
}

// ---------------------------------------------------------------------------
// Tests
// ---------------------------------------------------------------------------

#[test]
fn exploit_reinit_overwrites_authority() {
    // -----------------------------------------------------------------------
    // EXPLOIT: Config was initialized by Alice. Attacker calls init_vulnerable
    // again, overwriting Alice's authority with their own.
    //
    // Step 1: Alice initializes config (authority = Alice)
    // Step 2: Attacker calls init_vulnerable (authority → Attacker)
    // Step 3: Attacker now controls the config
    //
    // Expected: SUCCEEDS — no re-init guard exists.
    // -----------------------------------------------------------------------
    let mollusk = Mollusk::new(&PROGRAM_ID, "reinitialization");

    let alice = Pubkey::new_unique();
    let attacker = Pubkey::new_unique();
    let config_key = Pubkey::new_unique();

    // Config already initialized by Alice, with 1M in the vault
    let config_data = serialize_config(&alice, true, 1_000_000);
    let mut config_account =
        AccountSharedData::new(5_000_000, config_data.len(), &PROGRAM_ID);
    config_account.set_data_from_slice(&config_data);

    let attacker_account = AccountSharedData::new(1_000_000, 0, &solana_sdk::system_program::ID);

    // Attacker calls init_vulnerable — will overwrite Alice's authority
    let ix = Instruction::new_with_bytes(
        PROGRAM_ID,
        &ix_discriminator("init_vulnerable"),
        vec![
            AccountMeta::new(config_key, false),
            AccountMeta::new_readonly(attacker, true), // attacker signs as new authority
        ],
    );

    let accounts = vec![
        (config_key, config_account),
        (attacker, attacker_account),
    ];

    // Re-init succeeds — attacker now owns the config
    mollusk.process_and_validate_instruction(&ix, &accounts, &[Check::success()]);
}

#[test]
fn secure_blocks_reinit() {
    // -----------------------------------------------------------------------
    // SECURE: Same scenario — config was initialized by Alice. Attacker tries
    // init_secure, which checks is_initialized first.
    //
    // Expected: FAILS with AlreadyInitialized error.
    // -----------------------------------------------------------------------
    let mollusk = Mollusk::new(&PROGRAM_ID, "reinitialization");

    let alice = Pubkey::new_unique();
    let attacker = Pubkey::new_unique();
    let config_key = Pubkey::new_unique();

    // Config already initialized by Alice
    let config_data = serialize_config(&alice, true, 1_000_000);
    let mut config_account =
        AccountSharedData::new(5_000_000, config_data.len(), &PROGRAM_ID);
    config_account.set_data_from_slice(&config_data);

    let attacker_account = AccountSharedData::new(1_000_000, 0, &solana_sdk::system_program::ID);

    let ix = Instruction::new_with_bytes(
        PROGRAM_ID,
        &ix_discriminator("init_secure"),
        vec![
            AccountMeta::new(config_key, false),
            AccountMeta::new_readonly(attacker, true),
        ],
    );

    let accounts = vec![
        (config_key, config_account),
        (attacker, attacker_account),
    ];

    // AlreadyInitialized = error code 6000 (first #[error_code] variant)
    mollusk.process_and_validate_instruction(
        &ix,
        &accounts,
        &[Check::err(ProgramError::Custom(6000))],
    );
}

#[test]
fn secure_allows_first_init() {
    // -----------------------------------------------------------------------
    // SANITY: First-time init on an uninitialized config succeeds.
    // -----------------------------------------------------------------------
    let mollusk = Mollusk::new(&PROGRAM_ID, "reinitialization");

    let authority = Pubkey::new_unique();
    let config_key = Pubkey::new_unique();

    // Uninitialized config: is_initialized = false
    let config_data = serialize_config(&Pubkey::default(), false, 0);
    let mut config_account =
        AccountSharedData::new(5_000_000, config_data.len(), &PROGRAM_ID);
    config_account.set_data_from_slice(&config_data);

    let authority_account = AccountSharedData::new(1_000_000, 0, &solana_sdk::system_program::ID);

    let ix = Instruction::new_with_bytes(
        PROGRAM_ID,
        &ix_discriminator("init_secure"),
        vec![
            AccountMeta::new(config_key, false),
            AccountMeta::new_readonly(authority, true),
        ],
    );

    let accounts = vec![
        (config_key, config_account),
        (authority, authority_account),
    ];

    mollusk.process_and_validate_instruction(&ix, &accounts, &[Check::success()]);
}
